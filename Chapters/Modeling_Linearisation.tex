A general state space system is typically defined on the form in \cref{eq:state_space}. It is observed that a change in states over time is defined as a linear combination of vectors and matrices. Having a model on such a state space form is a necessary for state-space controller design.

\begin{equation} \label{eq:state_space}
	\begin{split}
		\dot{\textbf{x}} & = \textbf{A}\textbf{x} + \textbf{B}\textbf{u} + \textbf{B}_d\textbf{d} \\
		\textbf{y} 		& = \textbf{C}\textbf{x}
	\end{split}
\end{equation}

where

\begin{center}
	\begin{tabular}{l p{8cm} l}
		$\textbf{x}$       & State vector                    &  \\
		$\dot{\textbf{x}}$ & Time derivative of state vector &  \\
		$\textbf{y}$       & Output vector                   &  \\
		$\textbf{d}$       & Disturbance vector              &  \\
		$\textbf{A}$       & System matrix                   &  \\
		$\textbf{B}$       & Controllable input matrix       &  \\
		$\textbf{B}_d$     & Disturbance input matrix        &  \\
		$\textbf{C}$       & Output matrix                   &
	\end{tabular}
\end{center}

A prerequisite for making a controller is that the system model used for making the controller is linear. This chapter examines the linearisation of the non-linear model found in \cref{sec:mod}. Linearisation is achieved through a first order Taylor expansion.

Consider some system $\dot{\textbf{x}} = \textbf{f}(\textbf{x},\textbf{u},\textbf{d})$ with \textbf{x} a vector of system states, \textbf{u} a vector of controlled inputs, and \textbf{d} a vector of disturbances. Such a system can be approximated with a first order taylor expansion at an operating point ($\textbf{x}_o, \textbf{u}_o, \textbf{d}_o$) as such:

\begin{equation} \label{eq:taylor}
	\dot{\textbf{x}}   \approx   \textbf{f}(\textbf{x}_o, \textbf{u}_o, \textbf{d}_o)   +
	\left. \dfrac{\partial \textbf{f}}{\partial \textbf{x}} \right |_{\textbf{x}_o, \textbf{u}_o, \textbf{d}_o} \cdot (\textbf{x}-\textbf{x}_0) +
	\left. \dfrac{\partial \textbf{f}}{\partial \textbf{u}} \right |_{\textbf{x}_o, \textbf{u}_o, \textbf{d}_o} \cdot (\textbf{u}-\textbf{u}_0) +
	\left. \dfrac{\partial \textbf{f}}{\partial \textbf{d}} \right |_{\textbf{x}_o, \textbf{u}_o, \textbf{d}_o} \cdot (\textbf{d}-\textbf{d}_0)
\end{equation}

In \cref{eq:taylor} $f(\textbf{x}_o, \textbf{u}_o, \textbf{d}_o) = 0$ because the linearisation is done at an equilibrium point. The partial derivatives can be organized in Jacobian matrices on the form seen in \cref{eq:jacobians} where e is the number of state equations in the non linear system, and n is the number of variables to be differentiated with respect to, (e.g. number of states, inputs and disturbances).

\begin{equation} \label{eq:jacobians}
	\dfrac{\partial \textbf{f}}{\partial \textbf{x}} =
		\begin{bmatrix}
			\dfrac{\partial f_1}{\partial x_1} & \cdots & \dfrac{\partial f_1}{\partial x_n} & \\
			\vdots & \ddots & \vdots & \\
			\dfrac{\partial f_e}{\partial x_1} & \cdots & \dfrac{\partial f_e}{\partial x_n} &
		\end{bmatrix}, \
	\dfrac{\partial \textbf{f}}{\partial \textbf{u}} =
		\begin{bmatrix}
			\dfrac{\partial f_1}{\partial u_1} & \cdots & \dfrac{\partial f_1}{\partial u_n} & \\
			\vdots & \ddots & \vdots & \\
			\dfrac{\partial f_e}{\partial u_1} & \cdots & \dfrac{\partial f_e}{\partial u_n} &
		\end{bmatrix}, \
	\dfrac{\partial \textbf{f}}{\partial \textbf{d}} =
		\begin{bmatrix}
			\dfrac{\partial f_1}{\partial d_1} & \cdots & \dfrac{\partial f_1}{\partial d_n} & \\
			\vdots & \ddots & \vdots & \\
			\dfrac{\partial f_e}{\partial d_1} & \cdots & \dfrac{\partial f_e}{\partial d_n} &
		\end{bmatrix}
\end{equation}

When the Jacobian matrices are evaluated at the operating point, they in fact become the matrices $ \textbf{A} $, $ \textbf{B} $ and $ \textbf{B}_d  $ of the linear system:

\begin{equation}
	\left. \dfrac{\partial \textbf{f}}{\partial \textbf{x}} \right |_{\textbf{x}_o, \textbf{u}_o, \textbf{d}_o} = \textbf{A}, \
	\left. \dfrac{\partial \textbf{f}}{\partial \textbf{u}} \right |_{\textbf{x}_o, \textbf{u}_o, \textbf{d}_o} = \textbf{B}, \
	\left. \dfrac{\partial \textbf{f}}{\partial \textbf{d}} \right |_{\textbf{x}_o, \textbf{u}_o, \textbf{d}_o} = \textbf{B}_d
\end{equation}

The only difference from a standard state space system...

\subsubsection{Model Simplifications}
To model the behavior of the Hi-Fi simulation model, some simplifications with respect to the real system are made.

\begin{enumerate}
	\item valve is modeled as linear type
	\item coefficient XX is modelled as..
	\item
	\item
	\item
	\item
\end{enumerate}

From observing the system matrix (A) it is apparent that the first two states ($M_{PJJ}$ and $M_{Con}$) do not affect any states except themselves. They are not important with regards to any of the controlled states and are thus simply deleted from the system. In practice this means removing the first two: rows and columns of A, rows of B and columns of C.

When simulating the non-linear system model with inputs held constant at the operating point the state $M_v$ has a constant derivative which makes the state integrate towards infinity. This error is considered as a numeric error \todo[inline]{sikkert ikke sandt s√• skal sikkert rettes} and a simple fix is used to omit it. The slope of the error is subtracted from the definition of the derivative of the state. It is apparent that the system model does not in any way hold true to the physics of the real system and therefore such a fix which does not make sense in any physical context is considered acceptable.

