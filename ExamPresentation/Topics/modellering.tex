\begin{frame}{Modelling}{Introduction}
	A model of the refrigeration system is derived, linearised and further developed for observer based control.
	\begin{itemize}
		\item \textbf{Main goal:} Capture dynamics important for the box air temperature (main control objective)
		\begin{itemize}
			\item Thermal masses: Trailer box, cargo, evaporator, condenser.
		\end{itemize}
		\item \textbf{Modular approach:} Inputs, outputs, internal equations/states
		\item \textbf{Slow vs. fast dynamics:} States or algebraic equations
		\begin{itemize}
			\item Including faster dynamics yield more accurate model yet it is unnecessary from control perspective.
		\end{itemize}		
	\end{itemize}
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Component Models}
	Each component is modelled separately. The components are:
	\begin{itemize}
		\item Expansion Valve
		\item Pipe joining junction
		\item Compressor
		\item Condenser
		\item Flash tank
		\item Evaporator
		\item Box
	\end{itemize}
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Expansion Valve}
	\textbf{Purpose:} Lower pressure of liquid refrigerant from flash tank to evaporator.
	\begin{itemize}
		\item Adiabatic process: Modelled algebraicly
	\end{itemize}
	Flow through valve:
	\begin{equation} \label{eq:ExpansionValve_Alt}
		\begin{split}
			\dot{m} & = f_p(\Theta) K  \sqrt{\frac{1}{v_{in}} (p_{in} - p_{out})} \\
		\end{split}
	\end{equation}

	Table lookup:
	\begin{equation} \label{eq:ExpansionValve_vin}
		v_{in} = \mathcal{Z}(h_{in}, p_{in})
	\end{equation}
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Pipe joining junction}
	\textbf{Purpose:} Join refrigerant flows from between compressor stage 1 and two and the flash tank.
	\begin{itemize}
		\item States: $M$
	\end{itemize}
	Mass balance:
	\begin{equation}
	 \frac{dM}{dt} = \dot{m}_{in1} + \dot{m}_{in2} - \dot{m}_{out}       \label{eq:PipeJoiningJunction_ChangeOfMass}
	\end{equation}
	Enthalpy out:
	\begin{equation} \label{eq:PipeJoiningJunction_Enthalpy}
		h_{out} = \frac{h_{in1} \cdot \dot{m}_{in1} + h_{in2} \cdot \dot{m}_{in2}}{ \dot{m}_{in1} + \dot{m}_{in2} }
	\end{equation}
	
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Compressor}
	\textbf{Purpose:} Generate pressure sufficient for refrigerant flow and condenser heat flow
	\begin{itemize}
		\item Two compressor stages
		\item Only difference: Stage 2 has half the internal volume of stage 1
		\item Modelled as reciprocating (piston) compressor
		\item Modelled algebraicly - Fast dynamics do not affect slow evaporator dynamics 
	\end{itemize}
	Flow through compressor and enthalpy out
	\begin{align}
		\dot{m} &= \left(\frac{V_1}{v_1} - \frac{V_C}{v_2}\right) \frac{\omega}{2} \label{eq:comp_mass_flow} \\
		h_{out} &= \Upsilon(T_{out}, p_{out}) \label{eq:comp_enthalpy}
	\end{align}
\end{frame}

%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Condenser}
	\textbf{Purpose:} Exchange heat from hot vapour refrigerant to outside ambient air 
	\begin{itemize}
		\item Modelled as one Control Volume (CV)
		\item States: $M_r$ and $T_m$
	\end{itemize}
	\begin{figure}[h!]
		\centering
		\includegraphics[width=1\textwidth]{../Graphics/Condenser.pdf}
		\caption{Diagram of condenser control volume}
		\label{fig:condenser_CV}
	\end{figure}
\end{frame}

\begin{frame}{Condenser}{Equations}
	Energy balance:
	\begin{equation}
		h_{out} = h_{in} - \frac{Q_{rm}}{\dot{m}_{in}} \label{eq:Condenser_Enthalpy}
	\end{equation}
	Refrigerant mass balance:
	\begin{equation}
		\frac{dM_r}{dt} 	 = \dot{m}_{in}(t) - \dot{m}_{out}(t) \label{eq:Condenser_ChangeOfMass}
	\end{equation}
	Metal temperature:
	\begin{equation}
		\frac{dT_m}{dt} 	 = \frac{Q_{rm} - Q_{ma}}{M_m \cdot Cp_m} \label{eq:Condenser_ChangeOfTemperature}
	\end{equation}
\end{frame}




%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Flash tank}
	\textbf{Purpose:} Separate vapour and liquid refrigerant after condenser throttle valve (CDV)
	\begin{itemize}
		\item Modelled algebraicly
		\item Pressures out = in
	\end{itemize}
	\begin{figure}[h!]
		\centering
		\includegraphics[width=0.7\textwidth]{../Graphics/Flash_tank.pdf}
%		\caption{Diagram of Flash tank control volumes}
		\label{fig:flash_tank_CV}
	\end{figure}
	Mass balance:
\begin{equation}
	\dot{m}_{v} = \dot{m}_{lv} - \dot{m}_{l}  \label{eq:Flash_tank_massflow}
\end{equation}
Enthalpies:
\begin{equation}
	h_{l} = \mathcal{M}(p) \hspace{0.8cm} h_{v} = \mathcal{N}(p)
\end{equation}
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Evaporator}
	\textbf{Purpose:} Exchange heat from box air to cold liquid refrigerant
	\begin{itemize}
		\item Superheat is important control objective
		\item Modelled with two CVs: liquid-vapour and vapour
		\item Pressure out is simplified to being pressure in
		\item States: $T_{mlv}$, $T_{mv}$, $M_{lv}$, $M_{v}$ and $T_{v}$
	\end{itemize}
	
	\vspace{0.4cm}
	\begin{figure}[h!]
		\centering
		\includegraphics[width=1\textwidth]{../Graphics/Evaporator_CV_diagram.pdf}
		\caption{Diagram of evaporator liquid-vapour and liquid CVs split by $\sigma$}
		\label{fig:evap_CV}
	\end{figure}

\end{frame}

\begin{frame}{Evaporator}{Equations}
	Moving boundary and specific volume out
	\begin{equation}
		\sigma = \frac{M_{lv} \cdot v_1}{V_i} \label{eq:Evaporator_boundary}
	\end{equation}
	Liquid-vapour temperature:
	\begin{equation}
		\frac{dT_{mlv}}{dt}  = \frac{Q_{amlv}-Q_{mlv} + Q_{mvmlv}}{M_m \cdot \sigma \cdot Cp_m} \label{eq:evap_dT_ml}
	\end{equation}
	Vapour metal temperature:
	\begin{equation}
		\frac{dT_{mv}}{dt} = \frac{Q_{amv} - Q_{mv} - Q_{mvmlv}}{M_m \cdot (1 - \sigma) \cdot Cp_m} \label{eq:evap_dT_mv}
	\end{equation}
	Mass balances:
	\begin{equation} \label{eq:evap_dMlv}
		\frac{dM_{lv}}{dt} = \dot{m}_{in} - \dot{m}_{dew} \hspace{0.8cm}  \frac{dM_v}{dt} = \dot{m}_{dew} - \dot{m}_{out}
	\end{equation}
	Vapour refrigerant temperature:
	\begin{equation}\label{eq:tv_initial}
		\frac{dT_{v}}{dt} = \bar{T_v} - T_v
	\end{equation}

\end{frame}

%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Box}
	\textbf{Purpose:} Allow for convective heat transfer between cargo and circulating air
	\begin{itemize}
		\item Contains greatest thermal masses
		\item States: $T_{air}$, $T_{box}$ and $T_{cargo}$
	\end{itemize}
	\begin{figure}[h!]
		\centering
		\includegraphics[width=0.8\textwidth]{../Graphics/Box.pdf}
		\caption{Simplified diagram of trailer box}
		\label{fig:box_diagram}
	\end{figure}


\end{frame}

\begin{frame}{Box}{Equations}
	Air, box and cargo temperatures:
	\begin{align}
		\frac{dT_{air}}{dt} &= \frac{Q_{ca} + Q_{ba} + Q_{fan} -Q_{cool}}{M_{air} \cdot Cp_{air}} \label{eq:box_dT_air} \\
		\frac{dT_{box}}{dt} &= \frac{Q_{amb} - Q_{ba}}{M_{box} \cdot Cp_{box}} \label{eq:box_dT_box} \\
		\frac{dT_{cargo}}{dt} &= \frac{-Q_{ca}}{M_{cargo} \cdot Cp_{cargo}} \label{eq:box_dT_cargo}
	\end{align}
	Heat flows:
	\begin{align}
		Q_{cool}   & = Cp_{air} \cdot \dot{m}_{air} \cdot (T_{ret} - T_{sup})	\label{eq:box_Qcool} \\
		Q_{amb}    & = (T_{ambi} - T_{box}) \cdot U A_{amb}						\label{eq:box_Qab}   \\
		Q_{ba}     & = (T_{box} - T_{air}) \cdot U A_{ba}						\label{eq:box_Qba}   \\
		Q_{ca}     & = (T_{cargo} - T_{air}) \cdot U A_{ca}                  	\label{eq:box_Qca}
	\end{align}
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Component Input/Output relationship}
	\begin{itemize}
		\item \color{red} Red \color{black}: Missing outputs - Steady-state (SS) values from Hi-Fi simulation
		\item \color{blue} Blue \color{black}: Unused outputs of components
	\end{itemize}
	\begin{figure}[h!]
		\centering
		\includegraphics[width=1\textwidth]{../Graphics/Block_Diagram_inout_flowValveVersion.pdf}
		\label{fig:Block_diagram_inout}
	\end{figure}
	
\end{frame}

%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Component Input/Output relationship}
	\begin{itemize}
		\item All table lookups are SS variables at operating point (OP)
			\begin{itemize}
				\item Reduces complexity and eases linearisation
				\item Downside: Removes dependencies between states and inputs
			\end{itemize}
		\item Pressure/flow input/output setup leads to problems
			\begin{enumerate}
				\item Consider condenser throttle valve
				\item Input and output pressure are constant
			\end{enumerate}
	\end{itemize}
\end{frame}




%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Formulating non-linear state-space model}
	A non-linear state space model is formulated
	\begin{itemize}
		\item All state equations equations are collected in a $f(x,u)$ vector
		\item Algebraic equations are constraints
	\end{itemize}
	State vector and input vector:
	\begin{equation}  \label{eq:xu}
		\begin{split}
			x & = [M_{pjj}	\;
				M_{con} \;
				T_m \;
				\dot{m}_{air}\;
				T_{mlv}      \;
				T_{mv}       \;
				M_{lv}       \;
				M_v          \;
				T_{air}      \;
				T_{box}      \;
				T_{cargo}    \;
				T_v]^T \\
			u & = [\omega	\;
				\Theta_1	\;
				\Theta_2     \;
				U_{fan_1}    \;
				U_{fan_2}]^T \\
		\end{split}
	\end{equation}

\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Non-linear state-space system}
	\begin{figure}[h!]
		\centering
		\includegraphics[width=1\textwidth]{Graphics/f_x_u.jpeg}
		\label{fig:f_x_u}
	\end{figure}
\end{frame}





%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Verification}
	\begin{itemize}
		\item Model is verified with simulation
		\item Simulated at OP derived from Hi-Fi simulation
		\item Results shows 'faulty' states: $M_{pjj}$ and $M_{Con}$ with constant derivatives.
		\item Do not affect other states and are therefore removed from model
	\end{itemize}
	\begin{figure}[h]
		\centering
		\includegraphics[width=0.9\textwidth]{../Graphics/nonlin_sim_faulty_Mass.png}
		\label{fig:non_lin_sim_faulty_Mass}
	\end{figure}
\end{frame}




%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Verification}
	\begin{itemize}
		\item States: $M_{lv}$, $M_v$ and $\dot{m}_{air}$
		\item Mass of vapour inside evaporator has constant non-zero derivative at SS
		\item Considered numeric error and mitigated by subtracting function of compressor speed
	\end{itemize}
	\begin{figure}[h]
		\centering
		\includegraphics[width=1\textwidth]{../Graphics/nonlin_sim_Mass_Mvfucked.png}
		\caption{Notice two y-axis}
		\label{fig:non_lin_sim_Mass_Mvfucked}
		
	\end{figure}
	
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Verification}
	\begin{itemize}
		\item Likely cause: Simplifications in modelling section
		\begin{itemize}
			\item Pressure inside components not defined as states
			\item Results in mass inside states not affecting pressure and thereby flow through component
			\item Best example: Condenser throttle valve should be outputting pressure
		\end{itemize}
	\end{itemize}

\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Linearisation}
	\begin{itemize}
		\item Motivation: Non-linear model is not directly applicable control strategy 
		\item Linearisation is thus performed at relevant OP
	\end{itemize}
	Non-linear model is transformed to the following form:
	\begin{equation} \label{eq:state_space}
		\begin{split}
			\dot{x} & = Ax + Bu + B_dd \\
			y 		& = Cx
		\end{split}
	\end{equation}
	By using the first order taylor expansion:
	\begin{equation}
		f(x) \approx f(x_o) + \left. \dfrac{\partial f}{\partial x} \right |_{x_o} \cdot (x-x_0)		
	\end{equation}
	Where $f(x)$ = $\dot{x}$ and $x = (x, u, d)$


\end{frame}



%%%%%%%%%%%%%%%%%

%\begin{frame}{Modelling}{Linearisation}
%	Resulting full taylor expansion expression:
%	\begin{equation} \label{eq:taylor}
%		\begin{split}
%			\dot{x}   \approx   f(x_o, u_o, d_o)   & +
%			\left. \dfrac{\partial f}{\partial x} \right |_{x_o, u_o, d_o} \cdot (x-x_0)  + 
%			\left. \dfrac{\partial f}{\partial u} \right |_{x_o, u_o, d_o} \cdot (u-u_0) \\ & +
%			\left. \dfrac{\partial f}{\partial d} \right |_{x_o, u_o, d_o} \cdot (d-d_0)
%		\end{split}
%	\end{equation}
%	With each partial derivative yielding a Jacobian on the form:
%	\begin{equation} \label{eq:jacobians}
%		\dfrac{\partial f}{\partial x} =
%		\begin{bmatrix}
%			\dfrac{\partial f_1}{\partial x_1} & \cdots & \dfrac{\partial f_1}{\partial x_{nx}} & \\
%			\vdots & \ddots & \vdots & \\
%			\dfrac{\partial f_e}{\partial x_1} & \cdots & \dfrac{\partial f_e}{\partial x_{nx}} &
%		\end{bmatrix}
%	\end{equation}
%	Where derivatives are made with respect to both states, inputs and disturbance $(x,u,d)$
%	
%
%\end{frame}
%
%
%
%%%%%%%%%%%%%%%%%%
%
%\begin{frame}{Modelling}{}
%	Resultingly the system matrix, input and disturbance input matrices are:
%	\begin{equation}
%		\left. \dfrac{\partial f}{\partial x} \right |_{x_o, u_o, d_o} = A, \;\;
%		\left. \dfrac{\partial f}{\partial u} \right |_{x_o, u_o, d_o} = B, \;\;
%		\left. \dfrac{\partial f}{\partial d} \right |_{x_o, u_o, d_o} = B_d
%	\end{equation}
%	Notes regarding operating point:
%	\begin{itemize}
%		\item Should be at equilibrium
%		\item If not then some eigenvalues of $A$ will have zero real parts. 
%		\item In this case not all dynamics of the system are captured at that operating point (Hartman-Grobman theorem)
%	\end{itemize}
%\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Linearisation}
	\begin{itemize}
		\item Chosen operating point from Hi-Fi simulation is at $T_{air} = -5 ^{\circ} C$
		\item Resulting B matrix shows two inputs not mapping to states. These are simply removed.
	\end{itemize}
\begin{align}
	B = &\kbordermatrix{
		& \omega & \Theta_1 & \Theta_2 & U_{fan1} & U_{fan2} \\
		T_m 			& 0 & 0 & 0 & -0.0093 & 0\\
		\dot{m}_{air}	& 0 & 0 & 0 & 0 & \text{7.9630e-04}\\
		T_{mlv}			& 0 & 0 & 0 & 0 & 0\\
		T_{mv}			& 0 & 0 & 0 & 0 & 0.0011\\
		M_{lv}			& 0 & \text{5.0703e-04} & 0 & 0 & 0\\
		M_v 			& 0 & 0 & 0 & 0 & 0\\
		T_{air}  		& 0 & 0 & 0 & 0 & \text{1.0069e-04}\\
		T_{box}	 		& 0 & 0 & 0 & 0 & 0\\
		T_{cargo} 		& 0 & 0 & 0 & 0 & 0\\
		T_v 			& 0 & 0 & 0 & 0 & 0
	} \label{eq:B_full}
\end{align}
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Linearisation}
	\begin{itemize}
		\item $\omega$ and $\Theta_2$ not mapping to any states is unexpected
		\begin{itemize}
			\item Explanation: Too simple model - several components do not connect
			\item Example: No flow coupling between $\dot{m}_{in}$ and $\dot{m}_{out}$ of condenser results in no control of flow into evaporator
		\end{itemize}
		\item Resulting $A$ matrix is stable (only negative eigenvalues)
		\item One pole is $-1.3e-9$ which indicates a zero pole
		\begin{enumerate}
			\item Indicates that not all dynamics are captured by the chosen operating point
		\end{enumerate}
	\end{itemize}
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Controllability and Observability}
	\textbf{Controllability}
	\begin{itemize}
		\item Checked to ensure that all inputs map to states
		\item Controllability matrix should be full rank:
	\end{itemize}
	\begin{equation} \label{eq:ctrb}
		Q_c = [A|B] = \begin{bmatrix}  B & AB & \cdots & A^{n-1}B  \end{bmatrix}
	\end{equation}

	\textbf{Observability}
	\begin{itemize}
		\item Checked to ensure that all states map to outputs
		\item Observability matrix should be full rank:
	\end{itemize}
	\begin{equation}
		Q_o = [A|C] = \begin{bmatrix}
			C \\ CA \\ \vdots \\ CA^{n-1}
		\end{bmatrix}
	\end{equation}
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{}
	\begin{itemize}
		\item Controllability matrix is full rank: Rank of [A|B] = 10
		\item Observability matrix is \underline{not} full rank: Rank of [A|C] = 8
			\begin{itemize}
				\item Two states are not observable: $T_m$ and $M_v$
				\item Actions are taken to mitigate: Kalman decomposition for unobservable system
			\end{itemize}
	\end{itemize}
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Kalman decomposition for unobservable system}
	\begin{itemize}
		\item Used to remove unobservable states, leaving a fully observable system
	\end{itemize}
	For the Kalman decomposition, there exists a nonsingular P  $\in \mathbb{R} ^{n x n}$ such that
	\begin{equation}
		PAP^{-1} = \begin{bmatrix}
			A_{11}       & 0 \\
			A_{21}       & A_{22} \\
		\end{bmatrix}
	\end{equation}
	
	and
	
	\begin{equation}
		CP^{-1} = \begin{bmatrix}
			C_{1}       & 0 \\
		\end{bmatrix}
	\end{equation}
	
	where $A_{11} \in \mathbb{R} ^{l x l}$ and $C_{1} \in \mathbb{R} ^{p x l}$, where p is the number of outputs and l is the number of observable states.
	
	Input and disturbance matrices are transformed as such:
	\begin{equation}
		PB = \begin{bmatrix}
			B_1 \\
			B_2
		\end{bmatrix}, \
		PB_d = \begin{bmatrix}
			{B_d}_1 \\
			{B_d}_2
		\end{bmatrix}
	\end{equation}
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Kalman Decomposition reduced system}
	Resulting B matrix:
	\begin{align}
		B_1 & = \kbordermatrix{
			& \omega & \Theta_1 & \Theta_2 & U_{fan1} & U_{fan2} \\
			\dot{m}_{air}	& 0 & 0 & 0 & 0 & 0.00083\\
			T_{mlv}			& 0 & 0 & 0 & 0 & 0\\
			T_{mv}			& 0 & 0 & 0 & 0 & 0.0011\\
			M_{lv}			& 0 & 0.0005 & 0 & 0 & 0\\
			T_{air}  		& 0 & 0 & 0 & 0 & 0.0001\\
			T_{box}	 		& 0 & 0 & 0 & 0 & 0\\
			T_{cargo} 		& 0 & 0 & 0 & 0 & 0\\
			T_v 			& 0 & 0 & 0 & 0 & 0
		} \label{eq:B1}
	\end{align}
	\begin{itemize}
		\item Another input $U_{fan1}$ does not map to states
		\item Is also removed
	\end{itemize}
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{Condition number}
	\begin{itemize}
		\item Brings nuance to degree of controllability and observability
		\item "Large" condition numbers are generally undesirable
	\end{itemize}
	Definition:
	\begin{equation}
		\kappa (G(j\omega)) = \frac{\bar{\sigma}(G(j\omega))}{\underline{\sigma}(G(j\omega))}
	\end{equation}
	where $G(j\omega)$ is the transfer matrix of the system and
	\begin{itemize}
		\item $\bar{\sigma}$ is the largest singular value: Greatest gain at 'worst' input \textit{direction} and 'worst' frequency
		\item $\underline{\sigma}$ is the smallest singular value: Smallest gain at 'worst' input \textit{direction} and 'worst' frequency
	\end{itemize}
	Singular values are found from a Singular Value Decomposition (SVD) of the system.
	
	\begin{itemize}
		\item Condition numbers for $Q_c$ are: 1.195e+9 and 2.934e+8 for 'two state reduced' and Kalman decomposition reduced system respectively
	\end{itemize}
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{}
	\begin{itemize}
		\item 
	\end{itemize}
\end{frame}



%%%%%%%%%%%%%%%%%

\begin{frame}{Modelling}{}
	\begin{itemize}
		\item 
	\end{itemize}
\end{frame}

